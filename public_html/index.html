<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
	<head>
		<!-- Head - general definitions -->
		<title>osweb</title>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<!-- JavaScript -->
		<script type="text/javascript" src="js/osweb.js"></script>
		<script type="text/javascript" src="js/interface.js"></script>
		<!-- CSS -->
		<link rel="stylesheet" href="css/osweb.css"/>
		<!-- <link rel="stylesheet" href="http://cogsci.nl/theme/css/bootstrap.min.css"/> -->
		<!-- Fonts-->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css"/>
  		<link href='https://fonts.googleapis.com/css?family=Droid+Sans|Droid+Sans+Mono|Droid+Serif|Roboto|Roboto+Condensed|Ubuntu+Mono|Roboto+Slab' rel='stylesheet' type='text/css'>
	</head>

	<body>				
		<!-- Body - HTML definitions -->

		<nav class="navbar navbar-default navbar-fixed-top cogsci-navbar">
			<div class="container">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<a class="navbar-brand" style="padding: 7px" href="/">
						<img style="height: 100%" alt="Brand" src='img/opensesame.png'>
					</a>
				</div>
				<div id="navbar" class="collapse navbar-collapse">
					<form class="navbar-form navbar-right">
						<div class="form-group">
							<button class="btn btn-success" id="button4" type="button" status="run" onclick="runExperiment(); return false" disabled><i class="fa fa-play" aria-hidden="true"></i> Run</button>
							<button class="btn btn-default" id="fullscreen_button" type="button" onclick="toggleFullscreen(); return false" disabled><i class="fa fa-arrows-alt" aria-hidden="true"></i> Fullscreen</button>
							<button class="btn btn-default" id="console_button" type="button" onclick="toggleConsoleWindow(); return false"><i class="'fa fa-terminal" aria-hidden="true"></i> Console</button>
						</div>
					</form>

					<form class="navbar-form">
						<input type="file" id="browse" name="fileupload" style="display: none" onChange="Handlechange(event);"/>
						<div class="btn-group" style="display:inline;" role="group" aria-label="Load experiment">
							<button class="btn btn-primary" type="button" id="button1" onclick="HandleBrowseClick();">Local file</button>
							<button class="btn btn-primary" type="button" id="button2" onclick="loadServer();">Server file</button>
							<button class="btn btn-primary" id="button3" type="reset" onclick="loadScript();">Internal script</button>
						</div>
						
						<div class="form-group" style="display:inline;">
							<div class="input-group" style="display: table;">
								<span style="width: 1%" class="input-group-addon" id="loaded-exp">Loaded:</span>
								<input type="text" class="form-control" id="filename" placeholder="No experiment loaded" readonly />
							</div>
						</div>
					</form>
						

				</div><!--/.nav-collapse -->
			</div>
		</nav>

		<div class="container" style="margin-top:64px;">
			<div class="row">
				<div class="col-md-12">
					<div class="alert alert-warning">
					This is a tech preview of osweb. It is under heavy development, and not ready for general use!
					</div>
				</div>
			</div>
		</div>

	 	<div id="body_div">
			<div id="osweb_div">
				<canvas id="osweb_canvas" width="800" height="600"></canvas>
					<div id="osweb_console" style="display: none;"><textarea id="osweb_console_text" rows="4" cols="80" style="width:100%;background-color:#000000;color:#00FF00;"></textarea>
					</div>
					<div id="osweb_form" style=""></div>
				<div id="dialogoverlay"></div>
				<div id="dialogbox">
					<div>
						<div id="dialogboxhead"></div>
						<div id="dialogboxbody"></div>
						<div id="dialogboxfoot"></div>
					</div>
				</div>	
			</div>
		</div>

		<!-- Body - Hidden experiment video player -->
		<video id="osweb_video" width="1024" height="768"></video>
	</body>
</html>

<script>
// Activate noconflict mode of jQuery as it clashes with prototype.js
jQuery.noConflict();

// Set position of notifications
alertify.set('notifier', 'position', 'bottom-right');

// Extend existing 'alert' dialog
if(!alertify.errorAlert){
	//define a new errorAlert base on alert
	alertify.dialog('errorAlert',function factory(){
		return{
			build:function(){
				var errorHeader = '<span class="fa fa-times-circle fa-2x" '
				+	'style="vertical-align:middle;color:#e10000;">'
				+ '</span> Application Error';
				this.setHeader(errorHeader);
			}
		};
	},true,'alert');
}

window.onerror = function(msg, url, line, col, error) {
	var text = "<p><b>"+msg+"</b></p>" +
	"<p>See console for further details</p>";
	alertify.errorAlert(text);
}

// Prevent the run/stop button from keeping focus after the subject nr dialog box is
// closed. Otherwise the stop button is activated when users press spacebar for a
// response to the canvas.
document.getElementById('button4').onfocus = function(){
	this.blur();
};

var Experiment;
var Script;

// Hack to set the value of the file upload button
document.getElementById("button1").text = 'Select file'; 

// Event listener for fullscreen errors
// Use alert() for now, but think of something prettier (sAlert?)
if (screenfull.enabled) {
	document.addEventListener(screenfull.raw.fullscreenerror, function(){
		alertify.errorAlert('Failed to activate fullscreen');
	});
}

// Resize canvas to fit screen, when resized to fullscreen
if (screenfull.enabled) {
	document.addEventListener(screenfull.raw.fullscreenchange, function(){
		var c = document.getElementById('osweb_canvas');
		if(screenfull.isFullscreen) {
			c.old_width = c.style.width;
			c.old_height = c.style.height;
			var rect = c.getBoundingClientRect();
			c.style.width = rect.width;
			c.style.height = rect.height;
		} else {
			c.style.width = c.old_width;
			c.styleheight = c.old_height;
		}
	});
}

/**
 * Disable some buttons once an experiment is loaded.
 */
function buttonsSetToFileLoaded(){
	document.getElementById('button1').disabled = true;
	document.getElementById('button2').disabled = true;
	document.getElementById('button3').disabled = true;
	document.getElementById('button4').disabled = false;
}

/**
 * Enable experiment loading buttons.
 */
function buttonsSetToFileSelection(){
	document.getElementById('button1').disabled = false;
	document.getElementById('button2').disabled = false;
	document.getElementById('button3').disabled = false;
	document.getElementById('fullscreen_button').disabled = true;
	//document.getElementById('command_div').style.display = 'inherit';
}

function resetCanvas(){
	document.getElementById('osweb_div').style.width = '800px';
	document.getElementById('osweb_div').style.height = '600px';
	document.getElementById('osweb_canvas').width = 800;
	document.getElementById('osweb_canvas').height = 600;
	document.getElementById('osweb_canvas').style.background = "#000";
}

/**
 * Show canvas in fullscreen mode (Esc minimizes it again)
 * @return {void}
 */
function toggleFullscreen(){
	var c = document.getElementById('osweb_canvas');
	
	if (screenfull.enabled) {
		screenfull.request(c);
	}
}

/**
 * Show/hide console window used by the interpreter print method.
 * @return {void}
 */
function toggleConsoleWindow(){
	var c = document.getElementById('osweb_console');
	if (c.style.display === 'none') {
		c.style.display = '';
		}
	else {
		c.style.display = 'none';
	}	
};

/**
 * Methods for handling the hidden file load button.			 
 * @return {void}
 */

function HandleBrowseClick() {
	// Update the interface.
	var fileinput = document.getElementById("browse");
	fileinput.click();
}

function Handlechange(event) {
	// Update the button status.
	buttonsSetToFileLoaded();

	// Update the interface.
	var fileinput = document.getElementById("browse");
	var textinput = document.getElementById("filename");
	textinput.value = fileinput.value;

	alertify.message("Loaded local file: " + textinput.value);

	// Get the file.		  
	var file = event.target.files[0]; // Only select the first file.

	// Definition of the experiment object and its properties.
	Experiment = {'onfinished': onFinished, 'source': file};
}   

function loadServer(){
	// Update interface.
	buttonsSetToFileLoaded();

	// Get the file.		  
	var file = 'files/stroop.osexp'; // + document.getElementById("serverfile").value;

	var textinput = document.getElementById("filename");
	textinput.value = file;

	alertify.message("Loaded Remote file: " + textinput.value);
	
	// Definition of the experiment object and its properties.
	Experiment = {'onfinished': onFinished, 'source': file, 'target': 'php/data.php'};
};  

function loadScript(){
	// Update interface.
	buttonsSetToFileLoaded();

	Script = '---' + '\n' +
	 'API: 2' + '\n' +
	 'OpenSesame: 3.0.2' + '\n' +
	 'Platform: nt' + '\n' +
	 '---' + '\n' +
	 'set width 800' + '\n' +
	 'set uniform_coordinates "yes"' + '\n' +
	 'set title "New experiment"' + '\n' +
	 'set subject_parity "even"' + '\n' +
	 'set subject_nr 0' + '\n' +
	 'set start "block"' + '\n' +
	 'set height 600' + '\n' +
	 'set foreground "white"' + '\n' +
	 'set description "Default description"' + '\n' +
	 'set coordinates "uniform"' + '\n' +
	 'set compensation 0' + '\n' +
	 'set canvas_backend "xpyriment"' + '\n' +
	 'set background "black"' + '\n' +
	 '' + '\n' +
	 'define sequence block' + '\n' +
	 '	set flush_keyboard "yes"' + '\n' +
	 '	set description "Runs a number of items in sequence"' + '\n' +
	 '	run new_loop always' + '\n' +
	 '' + '\n' +
	 'define loop new_loop' + '\n' +
	 '	set skip 0' + '\n' +
	 '	set repeat 1' + '\n' +
	 '	set order "sequential"' + '\n' +
	 '	set offset "no"' + '\n' +
	 '	set item "trial"' + '\n' +
	 '	set description "Repeatedly runs another item"' + '\n' +
	 '	set cycles 2' + '\n' +
	 '	set column_order "stimulus;counter"' + '\n' +
	 '	set break_if "never"' + '\n' +
	 '	setcycle 0 stimulus "page 1<br/><br/>Next line"' + '\n' +
	 '	setcycle 0 counter "1"' + '\n' +
	 '	setcycle 1 stimulus "page 2"' + '\n' +
	 '	setcycle 1 counter "2"' + '\n' +
	 '	setcycle 2 stimulus "page 3"' + '\n' +
	 '	setcycle 2 counter "3"' + '\n' +
	 '	run trial' + '\n' +
	 '' + '\n' +
	 'define sequence trial' + '\n' +
	 '	set flush_keyboard "yes"' + '\n' +
	 '	set description "Runs a number of items in sequence"' + '\n' +
	 '	run welcome always' + '\n' +
	 '' + '\n' +
	 'define sketchpad welcome' + '\n' +
	 '	set start_response_interval "no"' + '\n' +
	 '	set reset_variables "no"' + '\n' +
	 '	set duration "keypress"' + '\n' +
	 '	set description "Displays stimuli"' + '\n' +
	 '	draw textline center=1 color=white font_bold=no font_family=serif font_italic=no font_size=32 html=yes show_if=always text="OpenSesame 3.0.0 [stimulus]" x=0 y=0 z_index=0' + '\n';
		
		// Definition of the experiment object and its properties.
	Experiment = {'onfinished': onFinished, 'source': Script};

	alertify.message("Loaded internal script");
	document.getElementById("filename").value = "Internal script";
};  

function runExperiment(){
	// Call again to make sure exp load buttons are disabled after
	// 'Run experiment' has been clicked
	buttonsSetToFileLoaded();

	if(document.getElementById('button4').getAttribute('status') == "run"){
		document.getElementById('button4').setAttribute('status','stop');
		document.getElementById('button4').innerHTML = '<i class="fa fa-stop" aria-hidden="true"></i> Stop';
		document.getElementById('button4').classList.remove("btn-success");
		document.getElementById('button4').classList.add("btn-danger");
		document.getElementById('fullscreen_button').disabled = false;
  		// Run the experiment within the Runner with the given canvas and experiment object.
		osweb.runner.run('osweb_canvas', Experiment); 
	}else{
		// Stop the experiment
		alertify.confirm('Stopping experiment', 'Are you sure you want to abort the experiment?', 
		function(){ osweb.runner.exit() }, 
		function(){ /* What to do when cancelled */})
		.set('labels', {ok:'Yes', cancel:'No'}); ;
		
	}
} 

function onFinished(pData, pSession_data){
	// Exit fullscreen mode, if applicable
	if (screenfull.enabled && screenfull.isFullscreen) {
		screenfull.exit();
	}

	document.getElementById('button4').value = "Run experiment";
	
	// Reset the canvas
	resetCanvas();

	// Reset the input buttons
	buttonsSetToFileSelection();

	document.getElementById('button4').setAttribute('status','run');
	document.getElementById('button4').innerHTML = '<i class="fa fa-play" aria-hidden="true"></i> Run';
	document.getElementById('button4').classList.remove("btn-danger");
	document.getElementById('button4').classList.add("btn-success");

	console.log(pData);
	console.log(pSession_data);
}
</script>
